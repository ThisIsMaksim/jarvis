#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Telegram AI Bot
# Ð—Ð°Ð¿ÑƒÑÐº: bash deploy-app.sh

set -e

echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Telegram AI Bot..."

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
APP_DIR="/opt/telegram-ai-bot"
SERVICE_NAME="telegram-ai-bot"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "package.json" ]; then
    print_error "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð³Ð´Ðµ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ package.json)"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    print_error ".env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo "Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ .env.example:"
    echo "cp .env.example .env"
    echo "Ð—Ð°Ñ‚ÐµÐ¼ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾ Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð² .env
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°..."
required_vars=("TELEGRAM_BOT_TOKEN" "MONGO_URI" "REDIS_URL")
missing_vars=()

for var in "${required_vars[@]}"; do
    if ! grep -q "^${var}=" .env || grep -q "^${var}=$" .env || grep -q "^${var}=.*_here" .env; then
        missing_vars+=("$var")
    fi
done

if [ ${#missing_vars[@]} -ne 0 ]; then
    print_error "ÐÐµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² .env:"
    printf '%s\n' "${missing_vars[@]}"
    exit 1
fi

print_success ".env Ñ„Ð°Ð¹Ð» ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
print_status "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pnpm install
print_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
print_status "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
pnpm build
print_success "ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð±Ñ€Ð°Ð½"

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ñ†ÐµÐ»ÐµÐ²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
print_status "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² $APP_DIR..."
sudo mkdir -p $APP_DIR
sudo cp -r dist/ $APP_DIR/
sudo cp -r node_modules/ $APP_DIR/
sudo cp package.json $APP_DIR/
sudo cp .env $APP_DIR/

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²
sudo chown -R telegram-bot:telegram-bot $APP_DIR
print_success "Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¸ Ð¿Ñ€Ð°Ð²Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
print_status "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOF
[Unit]
Description=Telegram AI Bot
After=network.target mongod.service redis.service
Wants=mongod.service redis.service

[Service]
Type=simple
User=telegram-bot
Group=telegram-bot
WorkingDirectory=$APP_DIR
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
StandardOutput=journal
StandardError=journal
SyslogIdentifier=telegram-ai-bot

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=$APP_DIR

[Install]
WantedBy=multi-user.target
EOF

print_success "Systemd ÑÐµÑ€Ð²Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½"

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
print_status "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME
sudo systemctl start $SERVICE_NAME

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
sleep 3
if sudo systemctl is-active --quiet $SERVICE_NAME; then
    print_success "Ð¡ÐµÑ€Ð²Ð¸Ñ $SERVICE_NAME Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
else
    print_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: sudo journalctl -u $SERVICE_NAME -f"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ webhook)
if grep -q "^WEBHOOK_URL=" .env && ! grep -q "^#WEBHOOK_URL=" .env; then
    print_status "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Ð´Ð»Ñ webhook..."
    
    # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð¾Ð¼ÐµÐ½ Ð¸Ð· WEBHOOK_URL
    DOMAIN=$(grep "^WEBHOOK_URL=" .env | cut -d'=' -f2 | sed 's|https\?://||' | cut -d'/' -f1)
    
    if [ -n "$DOMAIN" ]; then
        sudo tee /etc/nginx/sites-available/$SERVICE_NAME > /dev/null <<EOF
server {
    listen 80;
    server_name $DOMAIN;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

        # ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
        sudo ln -sf /etc/nginx/sites-available/$SERVICE_NAME /etc/nginx/sites-enabled/
        sudo nginx -t && sudo systemctl reload nginx
        
        print_success "Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° $DOMAIN"
        print_warning "Ð”Ð»Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: sudo certbot --nginx -d $DOMAIN"
    fi
else
    print_status "Webhook Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, Ð±Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð² polling Ñ€ÐµÐ¶Ð¸Ð¼Ðµ"
fi

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
print_success "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "sudo systemctl status $SERVICE_NAME    # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°"
echo "sudo journalctl -u $SERVICE_NAME -f    # Ð›Ð¾Ð³Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
echo "sudo systemctl restart $SERVICE_NAME   # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°"
echo "sudo systemctl stop $SERVICE_NAME      # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°"
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:"
echo "curl http://localhost:8080/healthz     # Health check"
echo ""
echo "ðŸ“± Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð° Ð² Telegram!"

# ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
echo ""
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
echo "MongoDB: $(sudo systemctl is-active mongod)"
echo "Redis: $(sudo systemctl is-active redis)"
echo "Nginx: $(sudo systemctl is-active nginx)"
echo "Telegram Bot: $(sudo systemctl is-active $SERVICE_NAME)"